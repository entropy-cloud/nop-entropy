# ========================================
# NOP CODE INDEXING GRAPHQL SCHEMA
# REFACTORED VERSION - DATABASE PERSISTED
# ========================================
#
# Design Philosophy:
# - All symbols belong to a NopCodeIndex
# - All entities use NopCode prefix and map to database tables
# - Follows Nop GraphQL conventions (Type__action naming)
# - Optimized for AI code generation and codebase understanding
#
# Entity Mapping:
# - NopCodeIndex → nop_code_index table
# - NopCodeSymbol → nop_code_symbol table
# - NopCodeClass → nop_code_class table
# - NopCodeMethod → nop_code_method table
# - NopCodeField → nop_code_field table
# - NopCodeAnnotation → nop_code_annotation table
# - NopCodeUsage → nop_code_usage table

# ========================================
# SCALARS & ENUMS
# ========================================

scalar CodeID

enum NopCodeSymbolKind {
  CLASS
  INTERFACE
  ENUM
  ANNOTATION
  METHOD
  CONSTRUCTOR
  FIELD
  VARIABLE
  PARAMETER
  TYPE_PARAMETER
  PACKAGE
}

enum NopCodeAccessModifier {
  PUBLIC
  PROTECTED
  PRIVATE
  PACKAGE_PRIVATE
  DEFAULT
}

enum NopCodeReferenceKind {
  READ
  WRITE
  CALL
  TYPE_REFERENCE
  EXTENDS
  IMPLEMENTS
  ANNOTATES
}

enum NopCodeHierarchyDirection {
  SUPER
  SUB
  BOTH
}

enum NopCodeCallDirection {
  INCOMING
  OUTGOING
  BOTH
}

# ========================================
# CORE TYPES
# ========================================

interface NopCodeNode {
  id: ID!
}

type NopCodeLocation {
  filePath: String!
  line: Int!
  column: Int!
  display: String!
}

# ========================================
# ENTITY TYPES
# ========================================

type NopCodeIndex implements NopCodeNode {
  id: ID!
  name: String!
  rootPath: String!
  language: String!
  symbolCount: Int!
  fileCount: Int!
  createTime: String
  updateTime: String

  files: [String!]!
}

type NopCodeSymbol implements NopCodeNode {
  id: ID!
  kind: NopCodeSymbolKind!
  name: String!
  qualifiedName: String!
  definition: NopCodeLocation!
  deprecated: Boolean!
  sourceCode(linesBefore: Int = 0, linesAfter: Int = 5): String!
  documentation: String
  modifiers: [NopCodeAccessModifier!]
  annotations: [NopCodeAnnotation!]
  parent: NopCodeSymbol
  usageCount: Int!

  indexId: String
  filePath: String
}

type NopCodeClass implements NopCodeNode {
  id: ID!
  name: String!
  qualifiedName: String!
  definition: NopCodeLocation!
  deprecated: Boolean!
  sourceCode(linesBefore: Int = 0, linesAfter: Int = 5): String!
  documentation: String
  modifiers: [NopCodeAccessModifier!]
  annotations: [NopCodeAnnotation!]
  parent: NopCodeSymbol
  usageCount: Int!

  superClass: NopCodeClass
  interfaces: [NopCodeInterface!]!
  fields: [NopCodeField!]!
  methods: [NopCodeMethod!]!
  subClasses: [NopCodeClass!]!

  indexId: String
  filePath: String
}

type NopCodeInterface implements NopCodeNode {
  id: ID!
  name: String!
  qualifiedName: String!
  definition: NopCodeLocation!
  deprecated: Boolean!
  sourceCode(linesBefore: Int = 0, linesAfter: Int = 5): String!
  documentation: String
  modifiers: [NopCodeAccessModifier!]
  annotations: [NopCodeAnnotation!]
  parent: NopCodeSymbol
  usageCount: Int!

  methods: [NopCodeMethod!]!
  implementors: [NopCodeClass!]!

  indexId: String
  filePath: String
}

type NopCodeMethod implements NopCodeNode {
  id: ID!
  name: String!
  qualifiedName: String!
  definition: NopCodeLocation!
  deprecated: Boolean!
  sourceCode(linesBefore: Int = 0, linesAfter: Int = 5): String!
  documentation: String
  modifiers: [NopCodeAccessModifier!]
  annotations: [NopCodeAnnotation!]
  parent: NopCodeSymbol
  usageCount: Int!

  returnType: NopCodeSymbol!
  parameters: [NopCodeParameter!]!
  exceptions: [NopCodeSymbol!]!
  overrides: [NopCodeMethod!]!
  signature: String!

  indexId: String
  filePath: String
}

type NopCodeField implements NopCodeNode {
  id: ID!
  name: String!
  qualifiedName: String!
  definition: NopCodeLocation!
  deprecated: Boolean!
  sourceCode(linesBefore: Int = 0, linesAfter: Int = 5): String!
  documentation: String
  modifiers: [NopCodeAccessModifier!]
  annotations: [NopCodeAnnotation!]
  parent: NopCodeSymbol
  usageCount: Int!

  type: NopCodeSymbol!

  indexId: String
  filePath: String
}

type NopCodeParameter implements NopCodeNode {
  id: ID!
  name: String!
  qualifiedName: String!
  definition: NopCodeLocation!
  deprecated: Boolean!
  sourceCode(linesBefore: Int = 0, linesAfter: Int = 5): String!
  documentation: String
  modifiers: [NopCodeAccessModifier!]
  annotations: [NopCodeAnnotation!]
  parent: NopCodeSymbol
  usageCount: Int!

  type: NopCodeSymbol!

  indexId: String
  filePath: String
}

type NopCodeAnnotation implements NopCodeNode {
  id: ID!
  name: String!
  qualifiedName: String!
  definition: NopCodeLocation!
  deprecated: Boolean!
  sourceCode(linesBefore: Int = 0, linesAfter: Int = 5): String!
  documentation: String
  modifiers: [NopCodeAccessModifier!]
  annotations: [NopCodeAnnotation!]
  parent: NopCodeSymbol
  usageCount: Int!

  arguments: [NopCodeAnnotationArgument!]!

  indexId: String
  filePath: String
}

type NopCodeAnnotationArgument {
  name: String!
  value: String!
}

# ========================================
# RELATIONSHIP & USAGE TYPES
# ========================================

type NopCodeUsage {
  location: NopCodeLocation!
  kind: NopCodeReferenceKind!
  symbol: NopCodeSymbol!
  context(before: Int = 2, after: Int = 2): String!

  indexId: String
}

type PageBean_NopCodeUsage {
  totalCount: Int!
  offset: Int!
  limit: Int!
  items: [NopCodeUsage!]!
}

# ========================================
# HIERARCHY TYPES
# ========================================

type NopCodeTypeHierarchy {
  root: NopCodeTypeHierarchyNode!
  direction: NopCodeHierarchyDirection!
}

type NopCodeTypeHierarchyNode {
  symbol: NopCodeClass!
  superTypes: [NopCodeClass!]!
  superInterfaces: [NopCodeInterface!]!
  subTypes: [NopCodeTypeHierarchyNode!]!
}

type NopCodeCallHierarchy {
  root: NopCodeCallHierarchyNode!
  direction: NopCodeCallDirection!
}

type NopCodeCallHierarchyNode {
  symbol: NopCodeMethod!
  toSymbols: [NopCodeMethod!]!
  incomingCalls: [NopCodeCallHierarchyNode!]!
  outgoingCalls: [NopCodeCallHierarchyNode!]!
}

# ========================================
# FILE OUTLINE TYPE
# ========================================

type NopCodeFileOutline {
  filePath: String!
  symbols: [NopCodeSymbol!]!
  indexId: String!
}

# ========================================
# PAGE BEAN TYPES
# ========================================

type PageBean_NopCodeSymbol {
  totalCount: Int!
  offset: Int!
  limit: Int!
  items: [NopCodeSymbol!]!
}

type PageBean_NopCodeClass {
  totalCount: Int!
  offset: Int!
  limit: Int!
  items: [NopCodeClass!]!
}

type PageBean_NopCodeMethod {
  totalCount: Int!
  offset: Int!
  limit: Int!
  items: [NopCodeMethod!]!
}

# ========================================
# QUERY TYPE
# ========================================

type Query {
  # === Index Queries ===

  "获取索引"
  NopCodeIndex__get(id: ID!): NopCodeIndex

  "通过路径获取索引"
  NopCodeIndex__findByPath(rootPath: String!): NopCodeIndex

  "通过索引ID获取所有文件"
  NopCodeIndex__getFiles(indexId: ID!): [String!]!

  # === Node & Symbol Queries ===

  "通过ID获取任意节点"
  NopCodeIndex__node(id: ID!): NopCodeNode

  "通过ID获取符号"
  NopCodeIndex__symbol(id: ID!): NopCodeSymbol

  "通过全限定名查找符号"
  NopCodeSymbol__findByQualifiedName(qualifiedName: String!, indexId: String): NopCodeSymbol

  "搜索符号（分页）"
  NopCodeSymbol__findPage(query: String!, kinds: [NopCodeSymbolKind!], indexId: String, offset: Int = 0, limit: Int = 20): PageBean_NopCodeSymbol!

  # === Specific Type Queries ===

  "通过ID获取类"
  NopCodeClass__get(id: ID!): NopCodeClass

  "通过全限定名获取类"
  NopCodeClass__findByQualifiedName(qualifiedName: String!, indexId: String): NopCodeClass

  "通过ID获取接口"
  NopCodeInterface__get(id: ID!): NopCodeInterface

  "通过全限定名获取接口"
  NopCodeInterface__findByQualifiedName(qualifiedName: String!, indexId: String): NopCodeInterface

  "通过ID获取方法"
  NopCodeMethod__get(id: ID!): NopCodeMethod

  "通过全限定名获取方法"
  NopCodeMethod__findByQualifiedName(qualifiedName: String!, indexId: String): NopCodeMethod

  # === Usage & Reference Queries ===

  "查找符号的所有使用（分页）"
  NopCodeUsage__findPage(symbolId: ID!, kind: NopCodeReferenceKind, offset: Int = 0, limit: Int = 20): PageBean_NopCodeUsage!

  "查找接口的所有实现类"
  NopCodeInterface__findImplementors(interfaceId: ID!): [NopCodeClass!]!

  "查找类的所有子类"
  NopCodeClass__findSubClasses(classId: ID!): [NopCodeClass!]!

  "查找方法的所有重写方法"
  NopCodeMethod__findOverrides(methodId: ID!): [NopCodeMethod!]!

  # === File & Source Queries ===

  "获取文件大纲"
  NopCodeFileOutline__get(filePath: String!, indexId: String!): NopCodeFileOutline

  "获取指定位置的源代码"
  NopCodeSource__get(filePath: String!, line: Int!, column: Int!, indexId: String!): String!

  # === Hierarchy Queries ===

  "获取类型层级"
  NopCodeTypeHierarchy__get(symbolId: ID!, direction: NopCodeHierarchyDirection! = BOTH, maxDepth: Int = 3): NopCodeTypeHierarchy!

  "获取调用层级"
  NopCodeCallHierarchy__get(symbolId: ID!, direction: NopCodeCallDirection! = BOTH, maxDepth: Int = 3): NopCodeCallHierarchy!

  # === List Queries ===

  "搜索符号列表（不分页）"
  NopCodeSymbol__findList(query: String!, kinds: [NopCodeSymbolKind!], indexId: String, limit: Int = 20): [NopCodeSymbol!]!
}

# ========================================
# MUTATION TYPE
# ========================================

type Mutation {
  "索引代码文件"
  NopCodeIndex__indexFiles(filePaths: [String!]!, indexId: ID!): Boolean

  "重新索引"
  NopCodeIndex__reindex(indexId: ID!): Boolean

  "删除索引"
  NopCodeIndex__delete(indexId: ID!): Boolean
}

# Implementation Tasks: Add Two-Factor Authentication (2FA)

## 1. 数据库设计和迁移

### 1.1 设计数据库表结构
- [ ] 1.1.1 设计`t_auth_2fa_config`表结构
- [ ] 1.1.2 设计`t_auth_sms_log`表结构
- [ ] 1.1.3 设计`t_sys_user`表的扩展字段
- [ ] 1.1.4 确定索引策略
- [ ] 1.1.5 编写DDL脚本

### 1.2 创建数据库迁移脚本
- [ ] 1.2.1 创建V2.0.1__add_2fa_tables.sql
- [ ] 1.2.2 测试迁移脚本在MySQL上的执行
- [ ] 1.2.3 测试迁移脚本在PostgreSQL上的执行
- [ ] 1.2.4 编写回滚脚本

### 1.3 创建实体类和DAO
- [ ] 1.3.1 创建`TwoFactorConfigEntity`实体类
- [ ] 1.3.2 创建`SmsLogEntity`实体类
- [ ] 1.3.3 扩展`UserEntity`添加2FA字段
- [ ] 1.3.4 创建`ITwoFactorConfigDao`接口
- [ ] 1.3.5 创建`ISmsLogDao`接口
- [ ] 1.3.6 实现DAO的MyBatis映射文件

## 2. 核心功能实现

### 2.1 TOTP功能实现
- [ ] 2.1.1 添加TOTP库依赖（Apache Commons Codec）
- [ ] 2.1.2 实现`TotpService.generateSecret()`方法
- [ ] 2.1.3 实现`TotpService.generateQrCode()`方法
- [ ] 2.1.4 实现`TotpService.verifyCode()`方法
- [ ] 2.1.5 编写TOTP单元测试

### 2.2 短信验证码功能实现
- [ ] 2.2.1 创建短信服务接口`ISmsService`
- [ ] 2.2.2 实现阿里云短信服务`AliyunSmsService`
- [ ] 2.2.3 实现腾讯云短信服务`TencentSmsService`
- [ ] 2.2.4 实现`SmsCodeService.generateCode()`方法
- [ ] 2.2.5 实现`SmsCodeService.verifyCode()`方法
- [ ] 2.2.6 实现发送频率限制
- [ ] 2.2.7 编写短信服务单元测试

### 2.3 恢复码功能实现
- [ ] 2.3.1 实现`RecoveryCodeService.generateCodes()`方法
- [ ] 2.3.2 实现`RecoveryCodeService.verifyCode()`方法
- [ ] 2.3.3 实现恢复码加密存储
- [ ] 2.3.4 实现恢复码使用后失效
- [ ] 2.3.5 编写恢复码单元测试

### 2.4 加密工具增强
- [ ] 2.4.1 扩展`CryptoService`添加AES加密方法
- [ ] 2.4.2 实现TOTP密钥加密
- [ ] 2.4.3 实现恢复码加密
- [ ] 2.4.4 实现短信验证码加密
- [ ] 2.4.5 编写加密工具单元测试

## 3. 业务逻辑层

### 3.1 2FA配置管理
- [ ] 3.1.1 实现`TwoFactorAuthService.enableTotp(userId)`方法
- [ ] 3.1.2 实现`TwoFactorAuthService.enableSms(userId, phone)`方法
- [ ] 3.1.3 实现`TwoFactorAuthService.disable(userId)`方法
- [ ] 3.1.4 实现`TwoFactorAuthService.getStatus(userId)`方法
- [ ] 3.1.5 实现`TwoFactorAuthService.switchMethod(userId, method)`方法

### 3.2 2FA验证逻辑
- [ ] 3.2.1 实现`TwoFactorAuthService.verify(userId, code, method)`方法
- [ ] 3.2.2 实现TOTP验证逻辑（含时间窗口）
- [ ] 3.2.3 实现短信验证码验证逻辑
- [ ] 3.2.4 实现恢复码验证逻辑
- [ ] 3.2.5 实现验证失败计数和锁定
- [ ] 3.2.6 编写业务逻辑集成测试

### 3.3 登录流程增强
- [ ] 3.3.1 修改`AuthService.login()`支持2FA流程
- [ ] 3.3.2 实现第一步验证返回临时令牌
- [ ] 3.3.3 实现第二步2FA验证
- [ ] 3.3.4 实现2FA验证通过后生成JWT
- [ ] 3.3.5 更新登录错误处理逻辑
- [ ] 3.3.6 编写登录流程集成测试

### 3.4 恢复码管理
- [ ] 3.4.1 实现`RecoveryCodeService.listCodes(userId)`方法
- [ ] 3.4.2 实现`RecoveryCodeService.regenerate(userId)`方法
- [ ] 3.4.3 实现恢复码使用历史记录
- [ ] 3.4.4 编写恢复码管理集成测试

## 4. API层

### 4.1 GraphQL Schema定义
- [ ] 4.1.1 定义`TwoFactorAuth`类型
- [ ] 4.1.2 定义`SmsLog`类型
- [ ] 4.1.3 定义`RecoveryCode`类型
- [ ] 4.1.4 定义`enableTotp` mutation
- [ ] 4.1.5 定义`enableSms` mutation
- [ ] 4.1.6 定义`disable2fa` mutation
- [ ] 4.1.7 定义`verify2fa` mutation
- [ ] 4.1.8 定义`listRecoveryCodes` query
- [ ] 4.1.9 定义`regenerateRecoveryCodes` mutation
- [ ] 4.1.10 定义`loginWith2fa` mutation

### 4.2 REST API实现
- [ ] 4.2.1 实现`POST /api/auth/totp/enable`接口
- [ ] 4.2.2 实现`POST /api/auth/totp/verify`接口
- [ ] 4.2.3 实现`POST /api/auth/totp/disable`接口
- [ ] 4.2.4 实现`POST /api/auth/sms/send`接口
- [ ] 4.2.5 实现`POST /api/auth/sms/verify`接口
- [ ] 4.2.6 实现`POST /api/auth/sms/disable`接口
- [ ] 4.2.7 实现`GET /api/auth/recovery-codes`接口
- [ ] 4.2.8 实现`POST /api/auth/recovery-codes/regenerate`接口
- [ ] 4.2.9 实现`POST /api/auth/login/2fa`接口
- [ ] 4.2.10 添加API文档注解

### 4.3 权限控制
- [ ] 4.3.1 配置2FA API的访问权限
- [ ] 4.3.2 实现用户只能管理自己的2FA配置
- [ ] 4.3.3 实现管理员可重置用户2FA
- [ ] 4.3.4 编写权限测试

## 5. 前端界面

### 5.1 2FA设置页面
- [ ] 5.1.1 创建2FA设置页面路由
- [ ] 5.1.2 设计2FA状态展示组件
- [ ] 5.1.3 实现TOTP启用向导
- [ ] 5.1.4 实现短信验证码启用向导
- [ ] 5.1.5 实现二维码显示组件
- [ ] 5.1.6 实现验证码输入组件
- [ ] 5.1.7 实现备用恢复码展示组件
- [ ] 5.1.8 实现禁用2FA确认对话框

### 5.2 登录页面增强
- [ ] 5.2.1 修改登录页面支持两步验证
- [ ] 5.2.2 实现第一步登录界面
- [ ] 5.2.3 实现第二步2FA验证界面
- [ ] 5.2.4 添加验证方式选择器
- [ ] 5.2.5 添加验证码错误提示
- [ ] 5.2.6 添加使用恢复码入口

### 5.3 2FA管理界面（管理员）
- [ ] 5.3.1 创建用户2FA管理页面
- [ ] 5.3.2 实现用户2FA状态查询
- [ ] 5.3.3 实现管理员重置用户2FA功能
- [ ] 5.3.4 实现强制启用2FA配置
- [ ] 5.3.5 实现2FA使用统计报表

### 5.4 前端测试
- [ ] 5.4.1 编写2FA设置页面组件测试
- [ ] 5.4.2 编写登录页面E2E测试
- [ ] 5.4.3 编写管理员页面测试

## 6. 配置管理

### 6.1 配置文件定义
- [ ] 6.1.1 在application.yaml中添加2FA配置项
- [ ] 6.1.2 添加TOTP配置（窗口大小等）
- [ ] 6.1.3 添加短信服务配置
- [ ] 6.1.4 添加验证码有效期配置
- [ ] 6.1.5 添加频率限制配置

### 6.2 配置验证和加载
- [ ] 6.2.1 创建配置类`TwoFactorAuthConfig`
- [ ] 6.2.2 实现配置验证逻辑
- [ ] 6.2.3 实现配置热更新支持
- [ ] 6.2.4 编写配置单元测试

## 7. 安全增强

### 7.1 防暴力破解
- [ ] 7.1.1 实现验证码失败计数器
- [ ] 7.1.2 实现临时锁定机制
- [ ] 7.1.3 实现IP地址级别的频率限制
- [ ] 7.1.4 记录安全事件到审计日志

### 7.2 会话管理
- [ ] 7.2.1 2FA验证后刷新会话
- [ ] 7.2.2 记录使用的验证方式
- [ ] 7.2.3 实现关键操作重新验证2FA
- [ ] 7.2.4 实现多设备2FA状态同步

### 7.3 日志和监控
- [ ] 7.3.1 记录所有2FA操作
- [ ] 7.3.2 记录失败的验证尝试
- [ ] 7.3.3 记录短信发送情况
- [ ] 7.3.4 添加性能监控指标
- [ ] 7.3.5 添加异常告警

## 8. 测试

### 8.1 单元测试
- [ ] 8.1.1 TOTP服务单元测试（覆盖率>90%）
- [ ] 8.1.2 短信服务单元测试（覆盖率>90%）
- [ ] 8.1.3 恢复码服务单元测试（覆盖率>90%）
- [ ] 8.1.4 加密工具单元测试（覆盖率>90%）
- [ ] 8.1.5 业务逻辑单元测试（覆盖率>80%）

### 8.2 集成测试
- [ ] 8.2.1 TOTP完整流程测试
- [ ] 8.2.2 短信验证码完整流程测试
- [ ] 8.2.3 恢复码使用测试
- [ ] 8.2.4 2FA登录完整流程测试
- [ ] 8.2.5 各种错误场景测试
- [ ] 8.2.6 性能测试（响应时间<500ms）

### 8.3 E2E测试
- [ ] 8.3.1 用户注册并启用2FA流程
- [ ] 8.3.2 使用2FA登录流程
- [ ] 8.3.3 使用恢复码登录流程
- [ ] 8.3.4 禁用2FA流程
- [ ] 8.3.5 管理员重置用户2FA流程
- [ ] 8.3.6 跨浏览器测试

### 8.4 安全测试
- [ ] 8.4.1 暴力破解防护测试
- [ ] 8.4.2 密钥加密验证测试
- [ ] 8.4.3 会话管理安全测试
- [ ] 8.4.4 CSRF防护测试
- [ ] 8.4.5 SQL注入防护测试

## 9. 文档

### 9.1 用户文档
- [ ] 9.1.1 编写用户2FA启用指南
- [ ] 9.1.2 编写2FA登录教程
- [ ] 9.1.3 编写恢复码使用说明
- [ ] 9.1.4 编写常见问题解答

### 9.2 管理员文档
- [ ] 9.2.1 编写2FA配置指南
- [ ] 9.2.2 编写短信服务配置教程
- [ ] 9.2.3 编写用户2FA管理指南
- [ ] 9.2.4 编写2FA安全策略建议

### 9.3 开发文档
- [ ] 9.3.1 编写API文档（Swagger）
- [ ] 9.3.2 编写架构设计文档
- [ ] 9.3.3 编写安全机制说明
- [ ] 9.3.4 编写代码示例

## 10. 部署和运维

### 10.1 部署脚本
- [ ] 10.1.1 编写数据库迁移部署脚本
- [ ] 10.1.2 编写配置模板
- [ ] 10.1.3 编写Docker镜像构建脚本
- [ ] 10.1.4 编写Helm Charts（Kubernetes部署）

### 10.2 监控和告警
- [ ] 10.2.1 添加2FA相关监控指标
- [ ] 10.2.2 配置短信发送失败告警
- [ ] 10.2.3 配置验证码失败率告警
- [ ] 10.2.4 配置性能指标告警

### 10.3 数据备份和恢复
- [ ] 10.3.1 确保2FA数据包含在备份中
- [ ] 10.3.2 测试数据恢复流程
- [ ] 10.3.3 编写灾难恢复计划

## 11. 代码审查和优化

### 11.1 代码审查
- [ ] 11.1.1 完成所有代码的自查
- [ ] 11.1.2 提交代码审查请求
- [ ] 11.1.3 响应审查意见
- [ ] 11.1.4 修复审查发现的问题
- [ ] 11.1.5 通过所有代码审查

### 11.2 性能优化
- [ ] 11.2.1 分析性能瓶颈
- [ ] 11.2.2 优化数据库查询
- [ ] 11.2.3 添加必要的缓存
- [ ] 11.2.4 优化加密解密性能
- [ ] 11.2.5 进行压力测试

### 11.3 安全审查
- [ ] 11.3.1 进行安全代码审查
- [ ] 11.3.2 运行安全扫描工具
- [ ] 11.3.3 修复安全漏洞
- [ ] 11.3.4 更新安全最佳实践

## 12. 发布准备

### 12.1 质量检查
- [ ] 12.1.1 确保所有测试通过
- [ ] 12.1.2 代码覆盖率达标（>70%）
- [ ] 12.1.3 无静态代码检查警告
- [ ] 12.1.4 完成安全扫描
- [ ] 12.1.5 完成性能测试

### 12.2 发布检查
- [ ] 12.2.1 更新CHANGELOG.md
- [ ] 12.2.2 更新版本号
- [ ] 12.2.3 编写发布说明
- [ ] 12.2.4 准备发布材料
- [ ] 12.2.5 制定发布计划

### 12.3 灰度发布
- [ ] 12.3.1 配置灰度发布规则
- [ ] 12.3.2 监控灰度发布指标
- [ ] 12.3.3 收集用户反馈
- [ ] 12.3.4 处理灰度期问题
- [ ] 12.3.5 准备全量发布

## 总计任务数：150+
## 预计完成时间：3-4周
## 优先级：高

---

**注意事项：**
1. 每个任务完成后请标记为`[x]`
2. 遇到阻塞问题及时更新任务状态
3. 保持任务列表与实际进度同步
4. 定期审查和更新任务优先级

services:
  # Opencode CLI + Server 混合模式
  opencode-cli:
    image: opencode-hybrid:latest  # 使用最新版本的混合镜像
    container_name: opencode-cli
    ports:
      # 暴露 OpenCode Server 端口（允许外部连接）
      - "3000:3000"
      # 暴露 3001 端口（用于其他服务）
      - "3001:3001"
    volumes:
      # 挂载项目文件到容器工作目录
      - /c/can/nop:/app/workspace:rw
      # 可选：挂载配置文件
      - /c/can/opencode/opencode-zhipu.json:/app/.opencode/config.json:ro
    working_dir: /app/workspace
    restart: unless-stopped
    stdin_open: true  # 保持 stdin 打开，用于交互式使用
    tty: true         # 分配伪终端
    environment:
      - NODE_ENV=production
      - OPENCODE_HOME=/app
      - OPENCODE_CONFIG=/app/.opencode/config.json
      - OPENCODE_WORKSPACE=/app/workspace
      # AI API Key（从宿主机传入）
      # - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # - OPENAI_API_KEY=${OPENAI_API_KEY}
    # 使用启动脚本同时运行 OpenCode Server 和 Vibe Kanban
    entrypoint: ["dumb-init", "--"]
    command: ["/app/start-services.sh"]

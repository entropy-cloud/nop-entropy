version: '3.8'

services:
  # Opencode CLI + Server 混合模式
  opencode-cli:
    image: opencode-hybrid:latest  # 使用最新版本的混合镜像
    container_name: opencode-cli
    ports:
      # 暴露 OpenCode Server 端口（允许外部连接）
      - "3000:3000"
    volumes:
      # 挂载项目文件到容器工作目录
      - /c/can/nop:/app/workspace:rw
      # 可选：挂载配置文件
      - /c/can/opencode/opencode-zhipu.json:/app/.opencode/config.json:ro
    working_dir: /app/workspace
    restart: unless-stopped
    stdin_open: true  # 保持 stdin 打开，用于交互式使用
    tty: true         # 分配伪终端
    environment:
      - NODE_ENV=production
      - OPENCODE_HOME=/app
      - OPENCODE_CONFIG=/app/.opencode/config.json
      - OPENCODE_WORKSPACE=/app/workspace
      # AI API Key（从宿主机传入）
      # - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # - OPENAI_API_KEY=${OPENAI_API_KEY}
    # 【修复】覆盖默认的 entrypoint，避免 Node.js 的 docker-entrypoint.sh 干扰
    # 使用 dumb-init 作为 PID 1，处理信号转发和孤儿进程
    entrypoint: ["dumb-init", "--"]
    # 直接使用完整路径启动 opencode serve
    command: ["/usr/local/bin/opencode", "serve", "--port", "3000", "--hostname", "0.0.0.0"]

<idea-plugin>
    <id>io.entropy.idea.plugin</id>
    <name>Nop Entropy</name>
    <version>2.0</version>
    <vendor email="canonical_entropy@163.com" url="https://gitee.com/canonical-entropy/nop-entropy">Canonical</vendor>

    <description><![CDATA[
    <p>Provides <a href="https://zhuanlan.zhihu.com/p/1942216215067100536">XLang</a> support to JetBrains IDEs.

    <h2>Features</h2>
    <ul>
      <li>Verify the DSL file format based on the xdef metamodel definition</li>
      <li>Provide debugging functionality for the Xpl template language</li>
    </ul>
    ]]></description>

    <change-notes><![CDATA[
    <ul>
    <li>修复在 xrun 脚本中的根节点直接引用 xlib 函数时未识别其引用的缺陷；</li>
    <li>修复启动 XLang 调试器时出现异常 Running sync tasks on pure EDT (w/o IW lock) is dangerous for several reasons 的问题；</li>
    <li>改进 XLang 文件解析过程中的异常处理逻辑，确保异常信息能够以告警形式显示，以便于排查；</li>
    <li>去掉 xchema 模版生成指令中的 xdef 路径补全宏，其性能太差，影响体验；</li>
    <li>不在属性的代码补全列表中包含内部的、已废弃的属性，且 xlib 函数中定义的隐式属性也不显示；</li>
    <li>支持对 xdef:key-attr、xdef:unique-attr 指向的属性是否存在进行检查，并在该属性未设置时给予告警提示；</li>
    <li>支持对 XML 转义后的 generic-type 类型字符串中的 class、数组、泛型参数以及预定义类型的识别；</li>
    <li>支持对 x:extends 中的 super 和 none 做特殊识别，确保前者可跳转到差量的上层 vfs 资源，而后者则不指向任何资源；</li>
    <li>支持对 xdef:body-type="union" 的节点的子节点做唯一性检查，并对多余的子节点给予告警提示；</li>
    <li>支持对 &lt;xdef:define/> 是否嵌套 &lt;xdef:define/> 进行检查，并对被嵌套的节点给予告警提示；</li>
    <li>支持对 Java 代码中的有效 vfs 资源路径字面量做引用跳转，可在代码中通过「Ctrl + 点击」直接跳转到 vfs 资源；</li>
    </ul>
    ]]></change-notes>

    <depends>com.intellij.modules.lang</depends>
    <depends>com.intellij.java</depends>
    <depends>com.intellij.gradle</depends>
    <depends>org.jetbrains.plugins.yaml</depends>

    <!-- please see http://www.jetbrains.org/intellij/sdk/docs/basics/getting_started/plugin_compatibility.html
         on how to target different products -->
    <!-- uncomment to enable plugin in all products
    <depends>com.intellij.modules.lang</depends>
    -->

    <resource-bundle>messages.NopPluginBundle</resource-bundle>

    <actions>
        <!--    <group id="entropy.ProjectFileActionGroup" text="Tasks For File"-->
        <!--           class="io.entropy.ide.plugin.actions.ProjectFileActionGroup" popup="true">-->
        <!--      <add-to-group group-id="ProjectViewPopupMenu" anchor="before" relative-to-action="FindUsages" />-->
        <!--    </group>-->

        <!--    <group id="entropy.EntropyPlatform" text="EntropyCloud" popup="true">-->
        <!--      <reference ref="entropy.ProjectFileActionGroup" />-->

        <!--      <separator />-->

        <!--      <group id="entropy.MainActionGroup" text="Entropy Tasks"-->
        <!--             class="io.entropy.ide.plugin.actions.MainActionGroup" >-->
        <!--      </group>-->

        <!--      <action id="entropy.RefreshConfig" text="RefreshConfig" class="io.entropy.ide.plugin.actions.RefreshConfigAction" />-->

        <!--      <add-to-group group-id="MainMenu" anchor="after" relative-to-action="ToolsMenu" />-->
        <!--    </group>-->
        <!-- Note: 国际化按 action.<action-id>.text/description 形式从 <resource-bundle/> 中取值 -->
        <action id="NopEntropy.NewXLang" class="io.nop.idea.plugin.template.CreateXLangFileFromTemplateAction"
                icon="io.nop.idea.plugin.icons.NopIcons.XLangFileType">
            <add-to-group group-id="NewGroup"/>
        </action>
    </actions>

    <!--    <extensions defaultExtensionNs="com.intellij">-->
    <!--    <xml.elementDescriptorProvider implementation="io.entropy.ide.plugin.validate.XplElementDescriptorProvider" />-->
    <!--    <xml.tagNameProvider implementation="io.entropy.ide.plugin.completion.XplTagNameProvider"/> &lt;!&ndash;解决根节点的tagName提示的问题 &ndash;&gt;-->
    <!--    <xml.xmlExtension implementation="io.entropy.ide.plugin.validate.XplXmlExtension" />&lt;!&ndash; 结合XplElementDescriptorProvider使用，该参数用来做元素校验，可校验某节点下是否可存在某元素 &ndash;&gt;-->

    <!-- 根据xdef定义进行语法提示 -->
    <!--        <completion.contributor language="XLang"-->
    <!--                                implementationClass="io.nop.idea.plugin.completion.XLangCompletionContributor"/>-->

    <!--        <lang.documentationProvider language="XLang"-->
    <!--                                    implementationClass="io.nop.idea.plugin.doc.XLangDocumentationProvider"/>-->

    <!--    &lt;!&ndash; Add your extensions here &ndash;&gt;-->
    <!--    <gotoDeclarationHandler implementation="io.entropy.ide.plugin.link.XLibDeclationHandler" />&lt;!&ndash; 点击ctrl能够链接到lib文件 &ndash;&gt;-->
    <!--    <gotoDeclarationHandler implementation="io.entropy.ide.plugin.link.VueDeclarationHandler" />&lt;!&ndash; 点击ctrl能够链接到lib文件 &ndash;&gt;-->

    <!--    <lang.syntaxHighlighterFactory language="Xpl" implementationClass="io.entropy.ide.plugin.language.XplSyntaxHighlighterFactory"/>-->
    <!--    <multiHostInjector implementation="io.entropy.ide.plugin.language.XplLanguageInjector" />-->
    <!--    </extensions>-->

    <applicationListeners>
        <listener class="io.nop.idea.plugin.services.NopAppListener"
                  topic="com.intellij.ide.AppLifecycleListener"/>
    </applicationListeners>

    <extensions defaultExtensionNs="com.intellij">

        <projectService serviceImplementation="io.nop.idea.plugin.services.NopProjectService"/>

        <!-- 新建文件模板 -->
        <internalFileTemplate name="New_XLang_XDef"/>
        <internalFileTemplate name="New_XLang_XDSL"/>
        <createFromTemplateHandler implementation="io.nop.idea.plugin.template.CreateXLangFileFromTemplateHandler"/>
        <!--  -->
        <defaultLiveTemplates file="liveTemplates/XLang_File"/>
        <liveTemplateContext contextId="XLang_File"
                             implementation="io.nop.idea.plugin.template.XLangFileLiveTemplateContextType"/>
        <liveTemplateMacro implementation="io.nop.idea.plugin.template.XLangRootTagNameMacro"/>
        <liveTemplateMacro implementation="io.nop.idea.plugin.template.XLangSchemaPathMacro"/>

        <!-- XLang 注册与解析 -->
        <!-- 根据后缀名做直接绑定 -->
        <fileType name="XLang"
                  language="XLang"
                  implementationClass="io.nop.idea.plugin.lang.XLangFileType"
                  fieldName="INSTANCE"
                  extensions="xdef;xdsl;xpl;xgen;xui;xlib;xrun;xwf;xmeta;xpage;xrule"/>
        <!-- 通过分析 xml 结构动态识别其是否为 XLang，避免穷举后缀，也避免遗漏 -->
        <lang.substitutor language="XML"
                          implementationClass="io.nop.idea.plugin.lang.XLangLanguageSubstitutor"/>
        <iconProvider implementation="io.nop.idea.plugin.lang.XLangIconProvider"
                      order="first"/>
        <!-- 解析 XLang 得到 PSI 树 -->
        <lang.parserDefinition language="XLang"
                               implementationClass="io.nop.idea.plugin.lang.XLangParserDefinition"/>
        <!-- 对 XLang DSL 进行语法校验 -->
        <annotator language="XLang"
                   implementationClass="io.nop.idea.plugin.annotator.XLangAnnotator"/>
        <highlightRangeExtension implementation="io.nop.idea.plugin.annotator.XLangHighlightRangeExtension"/>
        <!-- 对 XLang 做代码补全 -->
        <!--<completion.contributor language="XLang"
                                implementationClass="io.nop.idea.plugin.completion.XLangCompletionContributor"/>-->
        <!-- 显示 XLang 节点和属性的文档信息 -->
        <lang.documentationProvider language="XLang" order="first"
                                    implementationClass="io.nop.idea.plugin.doc.XLangDocumentationProvider"/>
        <!--<renamePsiElementProcessor implementation="io.nop.idea.plugin.lang.XLangElementRenameProcessor"/>-->

        <!-- XLang 调试 -->
        <xdebugger.breakpointType implementation="io.nop.idea.plugin.debugger.XLangBreakpointType"/>
        <programRunner id="XLangDebugger"
                       implementation="io.nop.idea.plugin.debugger.XLangDebuggerRunner"
                       order="before defaultDebugRunner"/>
        <executor id="xlangDebug"
                  implementation="io.nop.idea.plugin.execution.XLangDebugExecutor"
                  order="first,after run"/>
        <runConfigurationExtension
                implementation="io.nop.idea.plugin.debugger.XLangRunConfigurationExtension"/>

        <!-- XLang Script 注册与解析 -->
        <languageInjector implementation="io.nop.idea.plugin.lang.XLangScriptLanguageInjector"/>
        <fileType name="XLang Script"
                  language="XLangScript"
                  implementationClass="io.nop.idea.plugin.lang.script.XLangScriptFileType"
                  fieldName="INSTANCE"
                  extensions="xlangscript"/>
        <lang.parserDefinition language="XLangScript"
                               implementationClass="io.nop.idea.plugin.lang.script.XLangScriptParserDefinition"/>
        <lang.syntaxHighlighter language="XLangScript"
                                implementationClass="io.nop.idea.plugin.lang.script.XLangScriptSyntaxHighlighter"/>
        <lang.ast.factory language="XLangScript"
                          implementationClass="io.nop.idea.plugin.lang.script.XLangScriptASTFactory"/>
        <!-- Note: 可针对父类注册元素修改器 -->
        <lang.elementManipulator forClass="io.nop.idea.plugin.lang.script.psi.RuleSpecNode"
                                 implementationClass="io.nop.idea.plugin.lang.script.XLangScriptNodeManipulator"/>
        <renamePsiElementProcessor implementation="io.nop.idea.plugin.lang.script.XLangScriptNodeRenameProcessor"/>

        <!-- 从 Java 代码中识别引用 -->
        <psi.referenceContributor
                language="JAVA"
                implementation="io.nop.idea.plugin.lang.reference.XLangVfsPathInJavaReferenceContributor"/>
    </extensions>
</idea-plugin>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mind Elixir JSON æµ‹è¯•å·¥å…·</title>
    
    <!-- å¼•å…¥ mind-elixir çš„ CSS æ ·å¼ -->
    <link rel="stylesheet" href="https://unpkg.com/mind-elixir@5.1.1/dist/style.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            gap: 1px;
            background: #e2e8f0;
        }

        .left-panel {
            width: 40%;
            background: white;
            display: flex;
            flex-direction: column;
            min-width: 400px;
        }

        .right-panel {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
            min-width: 600px;
        }

        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 6px 12px;
            background: #0ea5e9;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 2s;
        }

        .btn:hover {
            background: #0284c7;
        }

        .btn-outline {
            background: transparent;
            color: #64748b;
            border: 1px solid #cbd5e1;
        }

        .btn-outline:hover {
            background: #f1f5f9;
            color: #334155;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 11px;
        }

        /* JSON ç¼–è¾‘å™¨æ ·å¼ */
        .json-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .json-toolbar {
            padding: 12px 16px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .json-examples {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        #json-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 16px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
            background: #fafafa;
            color: #2d3748;
            resize: none;
            tab-size: 2;
        }

        #json-input:focus {
            background: #ffffff;
        }

        .json-status {
            padding: 8px 16px;
            font-size: 12px;
            background: #f0f9ff;
            color: #0369a1;
            border-top: 1px solid #e2e8f0;
        }

        .json-status.error {
            background: #fef2f2;
            color: #dc2626;
        }

        .json-status.success {
            background: #f0fdf4;
            color: #16a34a;
        }

        /* æ€ç»´å¯¼å›¾æ ·å¼ */
        .mindmap-container {
            flex: 1;
            position: relative;
        }

        #mindmap {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        .mindmap-status {
            position: absolute;
            top: 16px;
            left: 16px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1000;
            max-width: 300px;
        }

        .mindmap-tips {
            position: absolute;
            bottom: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1000;
        }

        /* æ‹–æ‹½åˆ†éš”æ¡ */
        .resize-handle {
            width: 6px;
            background: #e2e8f0;
            cursor: col-resize;
            user-select: none;
            position: relative;
        }

        .resize-handle:hover {
            background: #cbd5e1;
        }

        .resize-handle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 20px;
            background: #94a3b8;
            border-radius: 1px;
        }

        /* Mind Elixir æ ·å¼è¦†ç›– */
        .mind-elixir {
            width: 100% !important;
            height: 100% !important;
            font-family: inherit !important;
        }

        .mind-elixir .map-container {
            background: transparent !important;
            cursor: grab;
        }

        .mind-elixir .map-container.grabbing {
            cursor: grabbing !important;
        }

        .mind-elixir .node {
            border-radius: 6px !important;
            border: 1px solid #e2e8f0 !important;
            background: #ffffff !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            font-family: inherit !important;
            font-size: 13px !important;
            padding: 8px 12px !important;
            min-width: 60px !important;
            text-align: center !important;
        }

        .mind-elixir .root {
            background: linear-gradient(135deg, #0f172a, #1e293b) !important;
            color: white !important;
            font-weight: 600 !important;
            font-size: 14px !important;
            border: none !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15) !important;
            padding: 10px 16px !important;
        }

        .mind-elixir .primary {
            background: #f8fafc !important;
            border-color: #cbd5e1 !important;
            color: #334155 !important;
            font-weight: 500 !important;
        }

        .mind-elixir .line {
            stroke: #475569 !important;
            stroke-width: 2 !important;
        }

        /* å“åº”å¼ */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }
            
            .left-panel {
                width: 100%;
                height: 40%;
                min-width: auto;
            }
            
            .right-panel {
                min-width: auto;
            }
            
            .resize-handle {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§ JSON ç¼–è¾‘å™¨é¢æ¿ -->
        <div class="left-panel">
            <div class="panel-header">
                <h2 class="panel-title">ğŸ“ JSON æ•°æ®ç¼–è¾‘å™¨</h2>
                <div class="btn-group">
                    <button class="btn btn-outline btn-sm" onclick="formatJSON()">æ ¼å¼åŒ–</button>
                    <button class="btn btn-outline btn-sm" onclick="clearJSON()">æ¸…ç©º</button>
                    <button class="btn btn-sm" onclick="updateMindMap()">æ›´æ–°å›¾è¡¨</button>
                </div>
            </div>
            
            <div class="json-toolbar">
                <div class="json-examples">
                    <button class="btn btn-outline btn-sm" onclick="loadExample('simple')">ç®€å•ç¤ºä¾‹</button>
                    <button class="btn btn-outline btn-sm" onclick="loadExample('complex')">å¤æ‚ç¤ºä¾‹</button>
                    <button class="btn btn-outline btn-sm" onclick="loadExample('project')">é¡¹ç›®æ¶æ„</button>
                </div>
                <div>
                    <label>
                        <input type="checkbox" id="auto-update" checked> è‡ªåŠ¨æ›´æ–°
                    </label>
                </div>
            </div>
            
            <div class="json-editor">
                <textarea id="json-input" placeholder="è¯·åœ¨æ­¤ç²˜è´´æˆ–ç¼–è¾‘æ‚¨çš„ JSON æ•°æ®..."></textarea>
            </div>
            
            <div id="json-status" class="json-status">
                å°±ç»ª - è¯·è¾“å…¥ JSON æ•°æ®
            </div>
        </div>

        <!-- æ‹–æ‹½åˆ†éš”æ¡ -->
        <div class="resize-handle" id="resize-handle"></div>

        <!-- å³ä¾§æ€ç»´å¯¼å›¾é¢æ¿ -->
        <div class="right-panel">
            <div class="panel-header">
                <h2 class="panel-title">ğŸ§  æ€ç»´å¯¼å›¾</h2>
                <div class="btn-group">
                    <button class="btn btn-outline btn-sm" onclick="fitView()">ğŸ¯ é€‚åº”è§†å›¾</button>
                    <button class="btn btn-outline btn-sm" onclick="exportImage()">ğŸ“· å¯¼å‡ºå›¾ç‰‡</button>
                    <button class="btn btn-outline btn-sm" onclick="resetMap()">ğŸ”„ é‡ç½®</button>
                    <button class="btn btn-outline btn-sm" onclick="expandAll()">â¬‡ï¸ å…¨éƒ¨å±•å¼€</button>
                    <button class="btn btn-outline btn-sm" onclick="collapseAll()">â¬†ï¸ å…¨éƒ¨æŠ˜å </button>
                </div>
            </div>
            
            <div class="mindmap-container">
                <div id="mindmap"></div>
                <div id="mindmap-status" class="mindmap-status" style="display: none;"></div>
                <div class="mindmap-tips">
                    å·¦é”®ï¼šèŠ‚ç‚¹é€‰æ‹©/ç¼–è¾‘/æŠ˜å  â€¢ èƒŒæ™¯æ‹–åŠ¨ä»¥å¹³ç§» â€¢ æ»šè½®ç¼©æ”¾ â€¢ å³é”®èŠ‚ç‚¹èœå•
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import MindElixir from 'https://unpkg.com/mind-elixir@5.1.1/dist/MindElixir.js';
        
        let mind;
        let panCleanupRef = null;
        let isResizing = false;

        // ç¤ºä¾‹æ•°æ®
        const examples = {
            simple: {
                "nodes": [
                    { "id": "root", "label": "æ ¹èŠ‚ç‚¹", "type": "Root" },
                    { "id": "child1", "label": "å­èŠ‚ç‚¹1", "type": "Module" },
                    { "id": "child2", "label": "å­èŠ‚ç‚¹2", "type": "Module" }
                ],
                "edges": [
                    { "source": "root", "target": "child1", "label": "åŒ…å«" },
                    { "source": "root", "target": "child2", "label": "åŒ…å«" }
                ]
            },
            complex: {
                "nodes": [
                    { "id": "company", "label": "å…¬å¸", "type": "Root", "evidence": "company.md:1" },
                    { "id": "tech", "label": "æŠ€æœ¯éƒ¨é—¨", "type": "Module", "evidence": "tech/overview.md:1" },
                    { "id": "sales", "label": "é”€å”®éƒ¨é—¨", "type": "Module", "evidence": "sales/overview.md:1" },
                    { "id": "frontend", "label": "å‰ç«¯å›¢é˜Ÿ", "type": "Service", "evidence": "tech/frontend.md:1" },
                    { "id": "backend", "label": "åç«¯å›¢é˜Ÿ", "type": "Service", "evidence": "tech/backend.md:1" },
                    { "id": "ui", "label": "UIè®¾è®¡", "type": "Component", "evidence": "design/ui.md:1" },
                    { "id": "api", "label": "APIå¼€å‘", "type": "Interface", "evidence": "api/docs.md:1" }
                ],
                "edges": [
                    { "source": "company", "target": "tech", "label": "ç®¡ç†", "type": "Manages" },
                    { "source": "company", "target": "sales", "label": "ç®¡ç†", "type": "Manages" },
                    { "source": "tech", "target": "frontend", "label": "åŒ…å«", "type": "Contains" },
                    { "source": "tech", "target": "backend", "label": "åŒ…å«", "type": "Contains" },
                    { "source": "frontend", "target": "ui", "label": "è´Ÿè´£", "type": "Responsible" },
                    { "source": "backend", "target": "api", "label": "å¼€å‘", "type": "Develops" }
                ]
            },
            project: {
                "nodes": [
                    { "id": "root", "label": "Webåº”ç”¨æ¶æ„", "type": "Root", "evidence": "docs/architecture.md:1" },
                    { "id": "frontend", "label": "å‰ç«¯å±‚", "type": "Module", "evidence": "src/frontend/index.js:1" },
                    { "id": "backend", "label": "åç«¯å±‚", "type": "Module", "evidence": "src/backend/app.py:1" },
                    { "id": "database", "label": "æ•°æ®å±‚", "type": "Storage", "evidence": "config/database.yml:5" },
                    { "id": "react", "label": "Reactæ¡†æ¶", "type": "Component", "evidence": "package.json:15" },
                    { "id": "nodejs", "label": "Node.js", "type": "Service", "evidence": "server.js:1" },
                    { "id": "mongodb", "label": "MongoDB", "type": "Storage", "evidence": "models/index.js:10" },
                    { "id": "redis", "label": "Redisç¼“å­˜", "type": "Storage", "evidence": "config/redis.js:5" },
                    { "id": "nginx", "label": "Nginx", "type": "Service", "evidence": "nginx.conf:1" }
                ],
                "edges": [
                    { "source": "root", "target": "frontend", "label": "åŒ…å«", "type": "Contains" },
                    { "source": "root", "target": "backend", "label": "åŒ…å«", "type": "Contains" },
                    { "source": "root", "target": "database", "label": "åŒ…å«", "type": "Contains" },
                    { "source": "frontend", "target": "react", "label": "ä½¿ç”¨", "type": "Uses" },
                    { "source": "backend", "target": "nodejs", "label": "åŸºäº", "type": "BasedOn" },
                    { "source": "database", "target": "mongodb", "label": "ä¸»å­˜å‚¨", "type": "Primary" },
                    { "source": "database", "target": "redis", "label": "ç¼“å­˜", "type": "Cache" },
                    { "source": "frontend", "target": "nginx", "label": "éƒ¨ç½²", "type": "Deploy" },
                    { "source": "backend", "target": "nginx", "label": "ä»£ç†", "type": "Proxy" }
                ]
            }
        };

        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('json-status');
            statusEl.textContent = message;
            statusEl.className = `json-status ${type}`;
        }

        function showMindMapStatus(message) {
            const statusEl = document.getElementById('mindmap-status');
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }

        // è½¬æ¢æ•°æ®ï¼šä¸ºèŠ‚ç‚¹æ·»åŠ  expandedï¼Œå¹¶æ”¯æŒå¾ªç¯æ£€æµ‹
        function convertToMindElixirData(data) {
            const { nodes, edges } = data;

            if (!nodes || nodes.length === 0) {
                return { topic: 'ç©ºç™½æ€ç»´å¯¼å›¾', id: 'root', root: true, expanded: true, children: [] };
            }

            // å›¾æ ‡æ˜ å°„
            const typeIcons = {
                'MavenProject': 'ğŸ“¦', 'ServiceLoaderConfig': 'ğŸ”Œ', 'CoreInitializer': 'ğŸš€', 'API': 'ğŸ“š',
                'CompilerFacade': 'ğŸ› ï¸', 'SPI Interface': 'ğŸ§©', 'ProviderImplementation': 'âš™ï¸',
                'Configuration': 'ğŸ“', 'Constants': 'ğŸ“Œ', 'Grammar': 'ğŸ“œ', 'GeneratedParser': 'ğŸ¤–',
                'GeneratedLexer': 'ğŸ¤–', 'Parser': 'ğŸ”', 'ParseTreeVisitor': 'ğŸŒ³', 'DomainModel': 'ğŸ›ï¸',
                'Builder': 'ğŸ—ï¸', 'Optimizer': 'âœ¨', 'Transformer': 'ğŸ’«', 'CompilerPass': 'ğŸš¶',
                'CodeGenerator': 'ğŸ’»', 'RuntimeBaseClass': 'åŸº', 'RuntimeExecutable': 'ğŸƒ',
                'RuntimeUtility': 'ğŸ”§', 'ExpressionParser': 'â—', 'ParserInterface': 'ğŸ“',
                'ParserBaseClass': 'ë¼ˆ', 'FunctionLibrary': 'ğŸ“–', 'Registry': 'ğŸ—‚ï¸',
                'ScriptCompiler': 'ğŸ“œ', 'TemplateCompiler': 'ğŸ“„', 'TemplateModelParser': 'ğŸ“‘',
                'TagCompilerSet': 'ğŸ”–', 'TemplateModelLoader': 'ğŸ“¤', 'SchemaParser': 'ğŸ§¬',
                'DomainRegistry': 'ğŸŒ', 'SchemaLoader': 'ğŸ“¥', 'XPathProvider': 'ğŸ§­',
                'OperatorRegistry': 'ğŸ›ï¸', 'XPathEvaluator': 'ğŸ•µï¸', 'CompileScope': 'ğŸ¯',
                'Scope': 'ğŸ¯', 'Utility': 'ğŸ’¡', 'ExecutionOrchestrator': ' orchestrator '
            };

            // 1. åˆ›å»ºèŠ‚ç‚¹æ± å’Œé‚»æ¥è¡¨
            const nodePool = new Map(nodes.map(node => [node.id, node]));
            const adj = new Map();
            const childIds = new Set();
            (edges || []).forEach(({ source, target, label }) => {
                if (!adj.has(source)) adj.set(source, []);
                adj.get(source).push({ childId: target, label: label || '' });
                childIds.add(target);
            });

            // 2. é€’å½’æ„å»ºæ ‘çš„å‡½æ•°
            const buildTree = (nodeId, edgeLabel, visited) => {
                // a. å¾ªç¯æ£€æµ‹
                if (visited.has(nodeId)) {
                    return {
                        id: `cycle-${nodeId}-${Math.random()}`,
                        topic: `â†ªï¸ (å¾ªç¯å¼•ç”¨) ${nodePool.get(nodeId)?.label || nodeId}`,
                        tags: ['Cycle'],
                        expanded: true,
                        children: []
                    };
                }

                const originalNode = nodePool.get(nodeId);
                if (!originalNode) return null;

                // b. åˆ›å»ºå½“å‰èŠ‚ç‚¹å¯¹è±¡
                const icon = typeIcons[originalNode.type] || 'ğŸ”¹';
                let topic = `${icon} ${originalNode.label}`;
                if (edgeLabel) {
                    topic = `(${edgeLabel}) ${topic}`;
                }
                
                // c. ä¸ºæ ‘ä¸­çš„æ¯ä¸ªå®ä¾‹åˆ›å»ºå”¯ä¸€IDï¼Œå¹¶é»˜è®¤å±•å¼€ï¼ˆæ”¯æŒæ”¶èµ·/å±•å¼€ï¼‰
                const mindElixirNode = {
                    id: `${nodeId}-${edgeLabel || ''}-${Math.random()}`,
                    topic: topic,
                    tags: originalNode.evidence ? [originalNode.evidence] : [],
                    hyperLink: originalNode.evidence ? `#${originalNode.evidence}` : undefined,
                    expanded: true, // å…³é”®
                    children: []
                };

                // d. é€’å½’æ„å»ºå­èŠ‚ç‚¹
                visited.add(nodeId);
                if (adj.has(nodeId)) {
                    for (const { childId, label } of adj.get(nodeId)) {
                        const childNode = buildTree(childId, label, visited);
                        if (childNode) {
                            mindElixirNode.children.push(childNode);
                        }
                    }
                }
                visited.delete(nodeId);

                return mindElixirNode;
            };

            // 3. å¯»æ‰¾æ ¹èŠ‚ç‚¹å¹¶æ„å»ºæ ‘
            const rootIds = nodes.map(n => n.id).filter(id => !childIds.has(id));
            const rootNodes = rootIds
                .map(rootId => buildTree(rootId, null, new Set()))
                .filter(Boolean);

            // 4. ç»„è£…æœ€ç»ˆç»“æœ
            let finalRoot;
            if (rootNodes.length === 0) {
                finalRoot = nodes.length > 0 ? buildTree(nodes[0].id, null, new Set()) : { topic: 'æ— æ•°æ®', id: 'root', expanded: true, children: [] };
            } else if (rootNodes.length === 1) {
                finalRoot = rootNodes[0];
            } else {
                finalRoot = {
                    id: 'virtual-root',
                    topic: 'ğŸ“¦ é¡¹ç›®æ¨¡å—æ¦‚è§ˆ',
                    expanded: true,
                    children: rootNodes,
                };
            }
            
            if (finalRoot) {
                finalRoot.root = true;
                finalRoot.expanded = true;
            }

            return finalRoot || { topic: 'æ•°æ®è½¬æ¢å¤±è´¥', id: 'fallback-root', root: true, expanded: true, children: [] };
        }
		
        // åˆå§‹åŒ– Mind Elixir
        async function initMindElixir(mindData) {
            const container = document.getElementById('mindmap');
            if (!container) return;

            container.innerHTML = '';

            if (panCleanupRef) {
                panCleanupRef();
                panCleanupRef = null;
            }

            if (mind) {
                mind.destroy?.();
            }

            const options = {
                el: container,
                direction: MindElixir.SIDE,
                draggable: true,
                contextMenu: true,
                toolBar: false,
                nodeMenu: true,
                keypress: true,
                locale: 'en',
                overflowHidden: false,
            };

            mind = new MindElixir(options);

            const mindElixirData = {
                nodeData: mindData,
            };

            mind.init(mindElixirData);

            const ensureFit = () => {
                try {
                    mind.scaleFit();
                    mind.toCenter();
                } catch (e) {
                    console.warn('é€‚åº”è§†å›¾å¤±è´¥:', e);
                }
            };

            requestAnimationFrame(ensureFit);
            setTimeout(ensureFit, 150);

            setupPanHandlers();

            mind.bus.addListener('selectNode', (node) => {
                console.log('é€‰ä¸­èŠ‚ç‚¹:', node);
                if (node.hyperLink) {
                    window.open(node.hyperLink, '_blank');
                }
            });

            mind.bus.addListener('operation', (operation) => {
                console.log('æ“ä½œ:', operation);
            });
        }

        // å¹³ç§»ï¼ˆèƒŒæ™¯æ‹–æ‹½ï¼‰å¤„ç†ï¼šé¿å…æ‹¦æˆªèŠ‚ç‚¹çš„æŠ˜å /å±•å¼€ç‚¹å‡»
        function setupPanHandlers() {
            const panState = {
                isPanning: false,
                lastX: 0,
                lastY: 0
            };

            const isOnMindNode = (target) => {
                if (!(target instanceof HTMLElement)) return false;
                return Boolean(
                    target.closest('.node') ||
                    target.closest('.node-container') ||
                    target.closest('[contenteditable]') ||
                    target.closest('[data-nodeid]') ||
                    target.closest('.toggle') ||
                    target.closest('.toggle-btn') ||
                    target.closest('.expand-btn') ||
                    target.closest('.me-btn') ||
                    target.closest('.topic')
                );
            };

            const handleMouseDown = (event) => {
                if (event.button !== 0) return;
                if (isOnMindNode(event.target)) return; // è®© Mind Elixir è‡ªå·±å¤„ç†ï¼ˆå«æŠ˜å /å±•å¼€ï¼‰

                panState.isPanning = true;
                panState.lastX = event.clientX;
                panState.lastY = event.clientY;
                if (mind.container) {
                    mind.container.style.cursor = 'grabbing';
                }
                // ä¸è¦ preventDefaultï¼Œé¿å…æ‹¦æˆªèŠ‚ç‚¹ç‚¹å‡»
            };

            const handleMouseMove = (event) => {
                if (!panState.isPanning) return;

                const dx = event.clientX - panState.lastX;
                const dy = event.clientY - panState.lastY;

                if (Math.abs(dx) < 1 && Math.abs(dy) < 1) return;

                mind.move(dx, dy);
                panState.lastX = event.clientX;
                panState.lastY = event.clientY;
                event.preventDefault(); // çœŸæ­£å¼€å§‹å¹³ç§»æ—¶å†é˜»æ­¢é»˜è®¤
            };

            const stopPanning = () => {
                if (!panState.isPanning) return;
                panState.isPanning = false;
                if (mind.container) {
                    mind.container.style.cursor = 'grab';
                }
            };

            mind.container?.addEventListener('mousedown', handleMouseDown);
            window.addEventListener('mousemove', handleMouseMove);
            window.addEventListener('mouseup', stopPanning);

            panCleanupRef = () => {
                mind.container?.removeEventListener('mousedown', handleMouseDown);
                window.removeEventListener('mousemove', handleMouseMove);
                window.removeEventListener('mouseup', stopPanning);
            };

            if (mind.container) {
                mind.container.style.cursor = 'grab';
            }
        }

        // JSON ç›¸å…³å‡½æ•°
        function validateAndParseJSON() {
            const input = document.getElementById('json-input').value.trim();
            
            if (!input) {
                showStatus('è¯·è¾“å…¥ JSON æ•°æ®', 'error');
                return null;
            }

            try {
                const data = JSON.parse(input);
                
                if (!data.nodes || !Array.isArray(data.nodes)) {
                    throw new Error('JSON æ•°æ®å¿…é¡»åŒ…å« nodes æ•°ç»„');
                }
                
                if (data.edges && !Array.isArray(data.edges)) {
                    throw new Error('edges å¿…é¡»æ˜¯æ•°ç»„');
                }

                showStatus(`âœ… JSON æœ‰æ•ˆ - ${data.nodes.length} ä¸ªèŠ‚ç‚¹ï¼Œ${(data.edges || []).length} æ¡è¾¹`, 'success');
                return data;
                
            } catch (error) {
                showStatus(`âŒ JSON é”™è¯¯: ${error.message}`, 'error');
                return null;
            }
        }

        function updateMindMap() {
            const data = validateAndParseJSON();
            if (!data) return;

            try {
                const mindData = convertToMindElixirData(data);
                initMindElixir(mindData);
                showMindMapStatus(`æˆåŠŸæ›´æ–° - ${data.nodes.length} ä¸ªèŠ‚ç‚¹`);
            } catch (error) {
                console.error('æ›´æ–°æ€ç»´å¯¼å›¾å¤±è´¥:', error);
                showMindMapStatus('æ›´æ–°å¤±è´¥: ' + error.message);
            }
        }

        function formatJSON() {
            const data = validateAndParseJSON();
            if (data) {
                document.getElementById('json-input').value = JSON.stringify(data, null, 2);
                showStatus('JSON å·²æ ¼å¼åŒ–', 'success');
            }
        }

        function clearJSON() {
            document.getElementById('json-input').value = '';
            showStatus('å·²æ¸…ç©º');
        }

        function loadExample(type) {
            const data = examples[type];
            if (data) {
                document.getElementById('json-input').value = JSON.stringify(data, null, 2);
                showStatus(`å·²åŠ è½½${type}ç¤ºä¾‹`, 'success');
                
                if (document.getElementById('auto-update').checked) {
                    setTimeout(updateMindMap, 100);
                }
            }
        }

        // æ€ç»´å¯¼å›¾æ§åˆ¶å‡½æ•°
        function fitView() {
            if (!mind) return;
            try {
                mind.scaleFit();
                mind.toCenter();
                showMindMapStatus('è§†å›¾å·²é€‚åº”');
            } catch (error) {
                showMindMapStatus('é€‚åº”è§†å›¾å¤±è´¥');
            }
        }

        async function exportImage() {
            if (!mind) return;
            try {
                const blob = await mind.exportPng();
                if (blob) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `mindmap-${new Date().toISOString().slice(0,10)}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showMindMapStatus('å›¾ç‰‡å¯¼å‡ºæˆåŠŸï¼');
                }
            } catch (error) {
                showMindMapStatus('å¯¼å‡ºå¤±è´¥');
            }
        }

        function resetMap() {
            if (!mind) return;
            try {
                const emptyData = {
                    topic: 'ğŸ  æ–°å»ºæ€ç»´å¯¼å›¾',
                    id: 'root',
                    root: true,
                    expanded: true,
                    children: []
                };
                
                mind.refresh({
                    nodeData: emptyData,
                });
                showMindMapStatus('æ€ç»´å¯¼å›¾å·²é‡ç½®');
            } catch (error) {
                showMindMapStatus('é‡ç½®å¤±è´¥');
            }
        }

        // é€’å½’è®¾ç½® expanded
        function walkSetExpanded(node, value, { keepRootExpanded = false, isRoot = true } = {}) {
            if (!node) return;
            if (keepRootExpanded && isRoot) {
                node.expanded = true;
            } else {
                node.expanded = value;
            }
            if (Array.isArray(node.children)) {
                node.children.forEach(child => walkSetExpanded(child, value, { keepRootExpanded, isRoot: false }));
            }
        }

        function expandAll() {
            if (!mind) return;
            const root = mind.nodeData || (mind.getAllData?.().nodeData) || (mind.getData?.());
            if (!root) return;
            walkSetExpanded(root, true);
            try {
                // ç›´æ¥åˆ·æ–°å½“å‰æ•°æ®
                mind.refresh();
                fitView();
                showMindMapStatus('å·²å…¨éƒ¨å±•å¼€');
            } catch (e) {
                console.warn(e);
            }
        }

        function collapseAll() {
            if (!mind) return;
            const root = mind.nodeData || (mind.getAllData?.().nodeData) || (mind.getData?.());
            if (!root) return;
            // æŠ˜å æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œä½†ä¿ç•™æ ¹èŠ‚ç‚¹å±•å¼€
            walkSetExpanded(root, false, { keepRootExpanded: true });
            try {
                mind.refresh();
                fitView();
                showMindMapStatus('å·²å…¨éƒ¨æŠ˜å ï¼ˆä¿ç•™æ ¹èŠ‚ç‚¹ï¼‰');
            } catch (e) {
                console.warn(e);
            }
        }

        // é¢æ¿æ‹–æ‹½è°ƒæ•´å¤§å°
        function setupResize() {
            const handle = document.getElementById('resize-handle');
            const leftPanel = document.querySelector('.left-panel');
            const container = document.querySelector('.container');

            handle.addEventListener('mousedown', () => {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                const containerRect = container.getBoundingClientRect();
                const percentage = ((e.clientX - containerRect.left) / containerRect.width) * 100;
                
                if (percentage > 20 && percentage < 70) {
                    leftPanel.style.width = `${percentage}%`;
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    
                    // é‡æ–°é€‚åº”æ€ç»´å¯¼å›¾è§†å›¾
                    setTimeout(() => {
                        if (mind) {
                            mind.refresh();
                            fitView();
                        }
                    }, 100);
                }
            });
        }

        // è‡ªåŠ¨æ›´æ–°åŠŸèƒ½
        function setupAutoUpdate() {
            const jsonInput = document.getElementById('json-input');
            const autoUpdate = document.getElementById('auto-update');
            let updateTimeout;

            jsonInput.addEventListener('input', () => {
                if (autoUpdate.checked) {
                    clearTimeout(updateTimeout);
                    updateTimeout = setTimeout(() => {
                        const data = validateAndParseJSON();
                        if (data) {
                            updateMindMap();
                        }
                    }, 1000); // 1ç§’å»¶è¿Ÿ
                }
            });
        }

        // å°†å‡½æ•°æŒ‚è½½åˆ°å…¨å±€å¯¹è±¡
        window.updateMindMap = updateMindMap;
        window.formatJSON = formatJSON;
        window.clearJSON = clearJSON;
        window.loadExample = loadExample;
        window.fitView = fitView;
        window.exportImage = exportImage;
        window.resetMap = resetMap;
        window.expandAll = expandAll;
        window.collapseAll = collapseAll;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            setupResize();
            setupAutoUpdate();
            
            // åŠ è½½é»˜è®¤ç¤ºä¾‹
            setTimeout(() => {
                loadExample('project');
            }, 500);
        });

        // æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (panCleanupRef) {
                panCleanupRef();
            }
            if (mind) {
                mind.destroy?.();
            }
        });
    </script>
</body>
</html>
# AI源码分析器 - 元提示词

## 任务概述

请基于以下需求，为一个大型Java项目设计和实现一个完整的AI源码分析器系统。该系统应该采用GraphQL接口和丰富的模型结构，支持语义级别的源码预处理和智能索引。

## 核心要求

### 1. 技术架构要求
- **跳过AST解析**：采用AI直接源码解析方式，利用大语言模型的语义理解能力
- **GraphQL接口**：设计丰富的GraphQL数据模型，支持灵活查询
- **多层次存储**：使用Neo4j图数据库、Elasticsearch全文搜索、向量数据库
- **语义化处理**：相比传统的RAG切分，采用功能导向的语义切分

### 2. 功能要求
- **多层次分析**：文件级、包级、模块级、语义级分析
- **跨文件理解**：能够理解类在完整项目上下文中的角色
- **文档智能理解**：理解代码注释、API文档、配置文档
- **架构模式识别**：自动识别微服务、分层、事件驱动等架构
- **配置深度分析**：分析构建依赖、安全配置、性能配置

## 需要生成的具体内容

### 1. 详细处理流程设计
需要设计从源码输入到查询服务的完整处理流程，包括：

#### 1.1 源码扫描和预处理阶段
- **文件发现策略**：递归扫描、文件过滤、类型识别
- **项目结构解析**：模块依赖分析、包结构构建
- **文件分组策略**：按功能、按模块、按类型的智能分组

#### 1.2 AI直接源码解析阶段
- **并行处理策略**：文件级、模块级、项目级并行处理
- **上下文收集**：跨文件上下文关联、配置关联、文档关联
- **语义理解深度**：功能识别、模式识别、复杂度评估

#### 1.3 关系提取和网络构建阶段
- **调用关系分析**：方法调用链、类依赖关系、跨模块调用
- **数据流分析**：输入输出跟踪、状态变化分析、异常传播
- **架构关系识别**：微服务边界、分层结构、事件驱动模式

#### 1.4 语义增强和知识提取阶段
- **功能摘要生成**：类职责描述、方法功能说明、API使用指导
- **最佳实践提取**：代码规范、设计原则、性能优化点
- **示例代码生成**：典型使用场景、配置示例、集成示例

#### 1.5 存储和索引构建阶段
- **图数据库存储**：Neo4j节点和关系模型设计
- **全文搜索索引**：Elasticsearch字段映射和分词策略
- **向量数据库索引**：语义向量生成和相似度搜索
- **缓存策略设计**：多级缓存、失效策略、预热机制

#### 1.6 查询服务执行阶段
- **GraphQL查询解析**：查询优化、字段选择、嵌套查询处理
- **多存储查询协调**：图查询+全文搜索+语义搜索的联合查询
- **结果聚合和排序**：相关性评分、优先级排序、分页处理
- **实时更新机制**：增量索引、缓存更新、订阅通知

### 2. 最终产物设计
需要明确每个处理阶段产生的具体产物：

#### 2.1 解析产物
- **结构化元数据**：类、方法、字段的完整结构信息
- **语义增强数据**：AI生成的功能描述、使用场景、最佳实践
- **关系网络数据**：调用链、依赖关系、架构关系图谱

#### 2.2 索引产物
- **图数据库索引**：节点属性索引、关系类型索引、路径查询索引
- **全文搜索索引**：倒排索引、同义词扩展、模糊匹配索引
- **语义向量索引**：高维向量索引、相似度计算索引、聚类索引

#### 2.3 缓存产物
- **热点数据缓存**：高频查询结果、复杂计算结果的缓存
- **预计算缓存**：关系路径预计算、统计信息预计算
- **会话缓存**：用户查询历史、个性化推荐缓存

### 3. 索引方式设计
需要设计具体的索引策略和优化方案：

#### 3.1 图数据库索引策略
- **节点索引**：基于类型、属性、标签的复合索引
- **关系索引**：关系类型、方向、属性的快速查找
- **路径索引**：常用查询路径的预计算和缓存

#### 3.2 全文搜索索引优化
- **字段分析策略**：不同字段的不同分词和分析策略
- **查询优化**：布尔查询、短语查询、模糊查询的优化
- **相关性调优**：TF-IDF、BM25、自定义评分函数的调优

#### 3.3 向量索引设计
- **向量化策略**：Sentence-BERT、自定义模型的向量生成
- **相似度计算**：余弦相似度、欧氏距离、自定义距离函数
- **索引结构**：HNSW、IVF、PQ等向量索引结构选择

### 4. 查询服务执行逻辑
需要设计查询服务的具体执行流程：

#### 4.1 查询解析和优化
- **查询语法解析**：GraphQL查询的语法解析和验证

## 文档编写规范

### 5. workflow.md文档编写要求
workflow.md文档必须使用mermaid图来表达完整的工作流程，并详细说明每个步骤的：

#### 5.1 流程图要求
- **使用mermaid语法**：采用标准的mermaid流程图语法
- **流程节点明确**：每个处理阶段作为独立节点
- **数据流向清晰**：明确输入输出数据的流向
- **并行处理标识**：标识并行处理的步骤
- **错误处理路径**：包含异常处理和重试机制

#### 5.2 步骤详细说明要求
每个处理步骤必须包含：
- **输入数据**：明确说明该步骤的输入数据类型和来源
- **处理逻辑**：详细描述处理逻辑和算法
- **输出数据**：明确说明输出数据的格式和内容
- **使用的提示词**：指定使用的具体提示词模板
- **错误处理**：描述可能的错误和应对策略

#### 5.3 提示词引用规范
- **提示词文件引用**：明确引用 `docs/prompts/` 目录下的具体提示词文件
- **模板名称指定**：指定使用的具体提示词模板名称
- **参数说明**：说明提示词模板中的参数如何填充
- **输出格式**：说明AI响应的预期格式和解析方式
- **查询重写**：复杂查询的分解和优化重写
- **执行计划生成**：多存储查询的执行计划优化

#### 4.2 多存储查询协调
- **查询路由**：根据查询类型路由到合适的存储
- **并行查询**：多个存储的并行查询执行
- **结果合并**：多源查询结果的合并和去重

#### 4.3 结果处理和返回
- **数据转换**：存储格式到GraphQL格式的转换
- **分页处理**：大数据集的分页和游标管理
- **错误处理**：查询失败的重试和降级策略

### 5. 项目结构设计
```
ai-analyzer/
├── docs/                    # 文档目录
├── src/                     # 源代码
├── config/                  # 配置文件
├── scripts/                 # 脚本文件
└── docker/                  # Docker配置
```

### 6. GraphQL数据模型设计
- 项目、模块、类、接口、方法等多层次数据模型
- 丰富的语义增强字段（AI生成的功能描述、关系网络等）
- 支持结构查询、关系查询、语义查询、示例查询

### 7. 完整的提示词体系
需要包含以下类别的提示词设计：

#### 7.1 代码分析提示词 (`code-analysis.md`)
- 类/接口结构分析
- 方法级别分析
- 设计模式识别
- 复杂度评估
- 使用模式提取
- 最佳实践识别

#### 7.2 语义提取提示词 (`semantic-extraction.md`)
- 方法功能描述提取
- 类职责语义提取
- 使用场景语义提取
- 配置语义提取
- 设计语义提取
- 性能语义提取
- 安全语义提取

#### 7.3 关系提取提示词 (`relationship-extraction.md`)
- 方法调用链分析
- 跨类调用关系
- 继承关系提取
- 依赖关系提取
- 数据流关系提取
- 配置关系提取
- 异常关系提取

#### 7.4 跨文件分析提示词 (`cross-file-analysis.md`)
- 多文件类理解分析
- 模块间关系分析
- 包级别分析
- 项目级别分析
- 依赖链分析
- 配置与代码关联分析

#### 7.5 文档理解提示词 (`documentation-understanding.md`)
- 注释与代码关联分析
- API文档理解
- 配置文件文档理解
- 项目文档理解
- 错误消息和日志理解
- 测试文档理解
- 部署运维文档理解

#### 7.6 架构模式识别提示词 (`architecture-patterns.md`)
- 微服务架构识别
- 分层架构识别
- 事件驱动架构识别
- 六边形架构识别
- CQRS架构识别
- 领域驱动设计识别
- 云原生架构识别

#### 7.7 配置和依赖分析提示词 (`configuration-dependency-analysis.md`)
- 构建依赖分析
- Spring配置分析
- 数据库配置分析
- 缓存配置分析
- 安全配置分析
- 日志配置分析
- 外部服务配置分析

### 8. XDef元模型定义

**重要说明：所有Nop平台相关知识必须参考 `docs-for-ai` 目录下的文档，特别是XDef元模型语言的语法和规范。**

- 为每个提示词定义XDef元模型，存储在独立的 `.xdef` 文件中
- XDef定义必须符合Nop平台的XDef规范
- 在提示词文档中通过 `## 返回格式` 章节引用对应的XDef文件
- 提供对应的JSON返回格式示例，确保与XDef定义一致

### 9. 配置文件
- `application.yml`：完整的应用配置
- `graphql-schema.graphqls`：GraphQL Schema定义
- `ai-prompt-templates.xdef`：统一的提示词元模型定义

## 具体实施要求

### 1. 处理流程的详细设计
需要为每个处理阶段设计具体的算法和策略：

#### 1.1 源码扫描阶段
- **文件发现算法**：支持多种文件类型的智能识别
- **增量扫描策略**：只处理变更的文件，支持增量更新
- **并行扫描优化**：多线程并行扫描，提升扫描效率

#### 1.2 AI解析阶段
- **提示词选择策略**：根据文件类型自动选择合适的提示词
- **上下文构建算法**：智能构建跨文件的上下文信息
- **结果验证机制**：AI解析结果的自动验证和纠错

#### 1.3 关系构建阶段
- **图构建算法**：高效的图数据库构建算法
- **关系去重策略**：避免重复关系的构建
- **图优化技术**：图数据的压缩和优化

#### 1.4 索引构建阶段
- **索引构建策略**：支持全量构建和增量构建
- **索引优化技术**：索引的压缩、分区、合并优化
- **索引维护机制**：索引的自动维护和重建

### 2. 查询服务的详细逻辑
需要设计查询服务的完整执行流程：

#### 2.1 查询解析层
- **语法解析器**：支持复杂的GraphQL查询语法
- **查询验证器**：验证查询的合法性和安全性
- **查询优化器**：查询的重写和优化

#### 2.2 查询执行层
- **查询路由器**：智能路由到合适的存储引擎
- **并行执行器**：支持多存储的并行查询执行
- **结果聚合器**：多源结果的合并和排序

#### 2.3 结果处理层
- **数据转换器**：存储格式到GraphQL格式的转换
- **分页处理器**：大数据集的高效分页处理
- **缓存管理器**：查询结果的智能缓存管理

### 3. 性能优化要求
需要设计具体的性能优化方案：

#### 3.1 处理性能优化
- **并行处理架构**：支持多级并行处理
- **内存优化策略**：高效的内存使用和管理
- **IO优化技术**：减少磁盘IO，提升处理速度

#### 3.2 查询性能优化
- **查询缓存策略**：多级查询缓存设计
- **索引优化技术**：高效的索引设计和优化
- **连接池管理**：数据库连接的高效管理

#### 3.3 扩展性设计
- **水平扩展方案**：支持集群部署和负载均衡
- **垂直扩展策略**：支持硬件资源的动态扩展
- **容错机制设计**：系统的高可用和容错设计

## 输出质量要求

### 1. 设计完整性
- 每个组件都要有详细的设计说明
- 包含具体的算法和实现策略
- 提供性能评估和优化建议

### 2. 技术可行性
- 设计方案要基于成熟的技术栈
- 考虑实际的实施难度和成本
- 提供替代方案和降级策略

### 3. 文档规范性
- 使用标准的文档格式和结构
- 包含清晰的示例和图表
- 提供完整的API文档和使用指南

### 4. 可维护性
- 设计要易于理解和维护
- 提供详细的注释和说明
- 包含测试方案和部署指南

## 验收标准

生成的系统设计应该满足以下验收标准：

1. **功能完整性**：覆盖所有要求的分析维度
2. **技术可行性**：基于成熟技术，可实际实施
3. **性能达标**：满足大规模项目的处理需求
4. **扩展性强**：支持未来的功能扩展
5. **文档完整**：提供完整的设计文档和使用指南

这个元提示词应该能够指导生成一个完整的、可实施的AI源码分析器系统设计方案。

## 输出格式要求

### 1. 文档结构
- 使用Markdown格式
- 包含清晰的标题层级
- 代码块使用正确的语言标记
- 重要的概念和关键词突出显示

### 2. 技术规范
- 所有提示词必须使用XDef元模型定义语言
- 每个提示词都要有明确的JSON返回格式示例
- GraphQL Schema要符合GraphQL规范
- 配置文件要符合YAML/GraphQL语法

### 3. 内容质量
- 设计要完整且可实施
- 架构要清晰且可扩展
- 示例要具体且实用
- 注释要详细且准确

## 实施策略

### 1. 渐进式实施
- 先基础后增强：从基础解析开始，逐步添加AI能力
- 模块化开发：每个组件独立开发测试
- 迭代优化：根据使用反馈持续改进

### 2. 性能优化
- 并行处理：文件级别、模块级别、项目级别并行
- 增量分析：只处理变更的文件，智能缓存
- 质量保证：结果验证、一致性检查、错误恢复

### 3. 质量保证
- 类型安全：使用XDef进行类型检查和约束验证
- 文档完整性：每个字段都有详细的XML注释
- 可扩展性：支持复杂嵌套结构，易于扩展

## 预期成果

通过这个元提示词，应该能够生成一个完整的、可实施的AI源码分析器系统设计，包括：

1. **完整的项目架构**：清晰的项目结构和模块划分
2. **丰富的GraphQL接口**：支持多种查询方式的GraphQL API
3. **智能的预处理工作流**：从源码到索引的完整处理流程
4. **全面的提示词体系**：覆盖代码分析的各个维度
5. **标准化的数据模型**：使用XDef定义的统一数据格式
6. **可操作的配置文件**：完整的应用配置和部署配置

这个系统应该能够将大型Java项目从"代码海洋"转变为"智能知识库"，提供毫秒级查询、语义搜索、关系可视化等高级功能。
# 关系提取提示词设计

## 1. 调用关系提取

### 1.1 方法调用链分析
**提示词模板**：
```
请分析以下Java代码中的方法调用关系：

{代码内容}

请严格按照 `config/ai-prompt-models.xdef` 中定义的 `MethodCallChainAnalysis` 模型结构提供JSON格式的响应。

**重要说明：所有Nop平台相关知识必须参考 `docs-for-ai` 目录下的文档，确保XDef定义符合规范。**
```

## 返回格式

**XDef模型定义**：参考 `config/ai-prompt-models.xdef` 中的 `MethodCallChainAnalysis` 模型

**JSON格式示例**：
```json
{
    <xdef:prop name="intermediateMethods" type="array" item-type="string" 
                comment="中间方法：经过哪些中间方法（仅间接调用）"/>
  </xdef:prop>
  
  <xdef:prop name="callCharacteristics" type="object" mandatory="true">
    <!-- 调用特征 -->
    <xdef:prop name="direction" type="string" mandatory="true" 
                comment="调用方向：forward|backward|bidirectional"/>
    <xdef:prop name="depth" type="integer" mandatory="true" 
                comment="调用深度：调用链的深度"/>
    <xdef:prop name="complexity" type="string" mandatory="true" 
                comment="调用复杂度：simple|complex"/>
  </xdef:prop>
  
  <xdef:prop name="callSemantics" type="object" mandatory="true">
    <!-- 调用语义 -->
    <xdef:prop name="functionalPath" type="string" mandatory="true" 
                comment="功能传递：调用链的功能传递路径"/>
    <xdef:prop name="dataFlowPath" type="string" mandatory="true" 
                comment="数据流：数据在调用链中的流动路径"/>
    <xdef:prop name="controlFlowPath" type="string" mandatory="true" 
                comment="控制流：控制权在调用链中的传递路径"/>
  </xdef:prop>
</xdef:model>

请严格按照上述XDef定义的结构返回JSON数据。
```

**输出格式**：
```json
{
  "caller": "methodName",
  "callees": [
    {
      "method": "fullMethodSignature",
      "type": "direct|indirect|callback|async",
      "position": "lineNumber",
      "frequency": "high|medium|low",
      "dataFlow": "inputData -> outputData",
      "intermediateMethods": ["中间方法"]
    }
  ],
  "callCharacteristics": {
    "direction": "forward|backward|bidirectional",
    "depth": 3,
    "complexity": "simple|complex"
  },
  "callSemantics": {
    "functionalPath": "调用链的功能传递路径",
    "dataFlowPath": "数据在调用链中的流动路径",
    "controlFlowPath": "控制权在调用链中的传递路径"
  }
}
```

### 1.2 跨类调用关系
**提示词模板**：
```
请分析以下类与其他类的调用关系：

{类代码}

请识别：

1. 服务依赖：
   - 依赖的服务类：被依赖的类
   - 依赖方向：单向依赖/双向依赖
   - 依赖强度：强依赖/弱依赖

2. 工具类调用：
   - 使用的工具类：工具类名称
   - 使用方式：静态调用/实例调用
   - 使用频率：高频使用/低频使用

3. 框架调用：
   - 框架接口实现：实现的框架接口
   - 框架回调：框架回调方法
   - 框架扩展点：使用的框架扩展点

4. 第三方库调用：
   - 第三方库：库名称和版本
   - 库功能：使用的库功能
   - 库集成方式：集成到代码中的方式
```

## 2. 继承关系提取

### 2.1 类继承关系
**提示词模板**：
```
请分析以下Java类的继承关系：

{类代码}

请提取：

1. 继承链：
   - 直接父类：直接继承的类
   - 祖先类：继承链上的所有祖先类
   - 继承深度：继承链的深度

2. 接口实现：
   - 实现的接口：直接实现的接口
   - 接口继承：通过父类继承的接口
   - 接口方法：需要实现的接口方法

3. 继承语义：
   - 继承目的：为什么选择继承
   - 方法重写：重写了哪些方法
   - 功能扩展：通过继承扩展了哪些功能

4. 设计模式：
   - 模板方法模式：是否使用模板方法
   - 策略模式：是否通过继承实现策略
   - 装饰器模式：是否使用装饰器模式
```

### 2.2 接口继承关系
**提示词模板**：
```
请分析以下接口的继承关系：

{接口代码}

请识别：

1. 接口扩展：
   - 扩展的接口：继承的父接口
   - 扩展的方法：新增的方法定义
   - 扩展的约束：新增的约束条件

2. 实现关系：
   - 实现类：实现该接口的类
   - 实现方式：不同的实现方式
   - 实现差异：不同实现的差异

3. 接口组合：
   - 组合接口：与其他接口的组合使用
   - 组合模式：接口组合的设计模式
   - 组合语义：组合后的语义含义
```

## 3. 依赖关系提取

### 3.1 编译时依赖
**提示词模板**：
```
请分析以下代码的编译时依赖关系：

{代码内容}

请识别：

1. 类依赖：
   - 直接依赖：通过import直接引用的类
   - 间接依赖：通过父类或接口间接依赖的类
   - 隐式依赖：通过反射或配置隐式依赖的类

2. 包依赖：
   - 包级别依赖：依赖的其他包
   - 包循环依赖：是否存在包循环依赖
   - 包隔离性：包的隔离程度

3. 模块依赖：
   - 模块间依赖：依赖的其他模块
   - 依赖方向：依赖的方向性
   - 依赖稳定性：依赖的稳定性评估
```

### 3.2 运行时依赖
**提示词模板**：
```
请分析以下代码的运行时依赖关系：

{代码内容}

请识别：

1. 资源依赖：
   - 配置文件：依赖的配置文件
   - 数据源：依赖的数据库或数据源
   - 外部服务：依赖的外部服务

2. 环境依赖：
   - 操作系统：依赖的操作系统特性
   - 运行时环境：依赖的JVM特性
   - 第三方服务：依赖的第三方服务

3. 动态依赖：
   - 反射依赖：通过反射动态加载的类
   - 插件依赖：动态加载的插件
   - 服务发现：通过服务发现依赖的服务
```

## 4. 数据流关系提取

### 4.1 方法间数据流
**提示词模板**：
```
请分析以下代码中的数据流关系：

{代码内容}

请跟踪数据流动：

1. 参数传递：
   - 输入参数：方法的输入参数
   - 参数转换：参数在方法内的转换
   - 输出结果：方法的返回结果

2. 字段访问：
   - 字段读取：读取的字段数据
   - 字段修改：修改的字段数据
   - 字段传递：字段数据在不同方法间的传递

3. 数据转换：
   - 格式转换：数据格式的转换
   - 类型转换：数据类型的转换
   - 业务转换：业务逻辑的数据转换

4. 数据生命周期：
   - 数据创建：数据的创建时机
   - 数据使用：数据的使用过程
   - 数据销毁：数据的销毁时机
```

### 4.2 跨方法数据流
**提示词模板**：
```
请分析跨方法的数据流关系：

{多个相关方法代码}

请分析：

1. 数据传递链：
   - 数据源头：数据的初始来源
   - 传递路径：数据经过的方法链
   - 最终目的地：数据的最终使用位置

2. 数据变换：
   - 数据增强：数据在传递过程中的增强
   - 数据过滤：数据在传递过程中的过滤
   - 数据聚合：多个数据源的聚合

3. 数据一致性：
   - 数据验证：数据在传递过程中的验证
   - 数据同步：多线程环境下的数据同步
   - 数据事务：事务边界内的数据一致性
```

## 5. 配置关系提取

### 5.1 代码与配置关系
**提示词模板**：
```
请分析以下代码与配置文件的关联关系：

{代码内容}
{配置文件内容}

请识别：

1. 配置引用：
   - 配置项读取：代码中读取的配置项
   - 配置键映射：配置键与代码变量的映射
   - 配置默认值：配置的默认值设置

2. 配置影响：
   - 功能开关：配置控制的功能开关
   - 行为调整：配置调整的系统行为
   - 性能参数：配置影响的性能参数

3. 配置依赖：
   - 配置顺序：配置的加载顺序依赖
   - 配置组合：多个配置项的组合使用
   - 配置冲突：可能冲突的配置项
```

## 6. 异常关系提取

### 6.1 异常传播关系
**提示词模板**：
```
请分析以下代码中的异常传播关系：

{代码内容}

请跟踪异常传播：

1. 异常抛出：
   - 异常类型：抛出的异常类型
   - 抛出位置：异常抛出的具体位置
   - 抛出条件：触发异常的条件

2. 异常捕获：
   - 捕获位置：异常被捕获的位置
   - 捕获处理：异常的处理方式
   - 异常转换：异常类型的转换

3. 异常传播链：
   - 传播路径：异常在调用链中的传播
   - 传播终止：异常传播的终止点
   - 最终处理：异常的最终处理方式

4. 异常语义：
   - 业务异常：业务逻辑相关的异常
   - 技术异常：技术实现相关的异常
   - 系统异常：系统环境相关的异常
```

## 关系提取质量保证

### 完整性检查
- **关系覆盖**：是否提取了所有重要关系
- **关系深度**：关系的深度是否足够
- **关系准确性**：提取的关系是否准确

### 一致性验证
- **双向关系**：双向关系的一致性
- **关系语义**：关系语义的一致性
- **关系权重**：关系权重的一致性

### 性能优化
- **增量提取**：支持增量关系提取
- **缓存策略**：关系结果的缓存策略
- **并行处理**：支持并行关系提取

这些关系提取提示词旨在构建完整的代码关系网络，为后续的图数据库存储和智能查询提供丰富的关系数据。
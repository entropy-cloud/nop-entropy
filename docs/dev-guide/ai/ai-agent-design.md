# AI Agent 设计文档

## 概述
AI Agent 是专门为特定任务和工作流配置的 AI 助手，允许创建具有自定义提示、模型和工具访问权限的专注工具。

## 代理类型

### 主要代理 (Primary Agents)
- **特点**：直接交互的主要助手，可访问所有配置的工具
- **切换方式**：使用 Tab 键或配置的快捷键
- **内置代理**：
  - **Build**：默认代理，启用了所有工具，适用于完整开发工作
  - **Plan**：限制性代理，专为计划和分析设计，所有修改操作默认设为"询问"模式

### 子代理 (Subagents)
- **特点**：专用于特定任务，可通过 @提及 手动调用
- **调用方式**：主代理自动调用或手动 @提及（如 `@general help me...`）
- **内置代理**：
  - **General**：通用代理，用于研究复杂问题和多步骤任务
  - **Explore**：快速代理，专门用于代码库探索

## 使用与导航

### 代理切换
- **主要代理**：Tab 键循环切换
- **子代理**：@提及调用

### 会话导航（子代理创建子会话时）
- **向前循环**：`<Leader>+Right`（父会话 → 子会话1 → 子会话2 → ... → 父会话）
- **向后循环**：`<Leader>+Left`

## 核心配置选项

### 基础配置
| 选项 | 说明 | 必填 |
|------|------|------|
| `description` | 代理功能描述 | 是 |
| `mode` | 代理模式：`primary`、`subagent`、`all` | 否，默认 all |
| `model` | 模型ID（格式：provider/model-id） | 否 |
| `temperature` | 响应随机性：0.0-1.0 | 否 |
| `maxSteps` | 最大迭代步骤数 | 否 |
| `disable` | 禁用代理：true/false | 否 |
| `prompt` | 自定义系统提示文件路径 | 否 |

### 工具与权限
```json
{
  "tools": {
    "write": true,      // 启用/禁用具体工具
    "mymcp_*": false    // 支持通配符
  },
  "permission": {
    "edit": "ask",      // ask/allow/deny
    "bash": {
      "git push": "ask",
      "*": "allow"      // 通配符，具体规则优先
    }
  }
}
```

### maxSteps 限制处理
当达到 `maxSteps` 时：
1. **停止迭代**：强制停止进一步工具调用
2. **系统提示**：代理收到特殊提示告知限制已到
3. **响应要求**：必须：
  - 总结已完成工作
  - 提供剩余任务建议
  - 仅使用文本响应（无工具调用）

## 配置方法

### JSON 配置（opencode.json）
```json
{
  "agent": {
    "agent-name": {
      "description": "...",
      "mode": "subagent",
      "model": "anthropic/claude-sonnet-4-20250514",
      "maxSteps": 10,
      "tools": {...},
      "permission": {...}
    }
  }
}
```

### Markdown 配置
- **文件位置**：
  - 全局：`~/.config/opencode/agent/`
  - 项目：`.opencode/agent/`
- **文件名即代理名**：如 `review.md` 创建 review 代理

## 创建与使用

### 创建代理
```bash
opencode agent create
```
交互式流程：选择位置 → 描述功能 → 生成提示 → 选择工具 → 创建配置

### 典型使用场景
| 代理类型 | 工具权限 | 适用场景 |
|----------|----------|----------|
| **Build** | 全部启用 | 完整开发、文件操作、系统命令 |
| **Plan** | 全部禁用/询问 | 代码分析、变更建议、制定计划 |
| **Review** | 只读+文档 | 代码审查、最佳实践检查 |
| **Debug** | bash+读取 | 问题调查、日志分析 |
| **Docs** | 文件操作 | 文档编写、注释更新 |

### 示例代理
1. **文档编写代理**：专注于清晰、结构化的文档创建
2. **安全审计代理**：识别安全漏洞和风险点

## 最佳实践
1. **任务专精**：为不同任务创建专用代理
2. **权限控制**：使用权限系统管理高风险操作
3. **成本控制**：通过 `maxSteps` 限制长时间运行
4. **温度调整**：根据任务类型调整响应随机性
5. **模型匹配**：为任务选择合适模型（快速 vs 深度）

## 配置优先级
1. 代理特定配置
2. 全局工具配置
3. 默认模型设置
